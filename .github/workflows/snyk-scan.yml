name: Fetch Snyk Report from Portal # Workflow name

on:
  push:
    branches: [master]

jobs:
  fetch-snyk-report:
    runs-on: ubuntu-latest # Run on a fresh Ubuntu environment
    permissions:
      contents: write # Grant write access for committing the report

    steps:
      - uses: actions/checkout@v4 # Checkout your repository code

      - uses: actions/setup-node@v4 # Setup Node.js for 'curl' and environment

      - name: Fetch Snyk report via API # Step to call Snyk API
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }} # Your Snyk API token (GitHub Secret)
          SNYK_ORG_ID: ${{ secrets.SNYK_ORGANIZATION_ID}} # <<=== CHANGE THIS: Your Snyk Organization ID
          SNYK_PROJECT_ID: ${{ secrets.SNYK_PROJECT_ID}} # <<=== CHANGE THIS: Your Snyk Project ID
        run: |
          mkdir -p reports # Create 'reports' directory
          # Fetch project issues as JSON; '|| true' allows step to pass even if API returns no issues
          curl -s -X GET "https://api.snyk.io/rest/orgs/${{ env.SNYK_ORG_ID }}/projects/${{ env.SNYK_PROJECT_ID }}/issues?version=2024-06-03~beta" -H "Authorization: token ${{ env.SNYK_TOKEN }}" -H "Content-Type: application/vnd.api+json" > reports/snyk-results.json || true
          # Display a warning if report is empty
          [ -s reports/snyk-results.json ] || echo "Warning: snyk-results.json is empty. Check your IDs and Snyk API access."

      - name: Commit and push report # Commit and push the generated report
        run: |
          git config user.name "github-actions[bot]" # Set Git user name for commit
          git config user.email "github-actions[bot]@users.noreply.github.com" # Set Git user email for commit
          git add reports/snyk-results.json # Stage the report file
          git diff-index --quiet HEAD -- || git commit -m "chore: Update Snyk vulnerability report from portal" # Commit only if changes exist
          git push # Push changes to the repository

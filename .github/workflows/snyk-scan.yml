name: Snyk Auto-Update Vulnerability Report

on:
  push:
    branches: [master]
    paths:
      - '**/pom.xml'  # Only trigger when dependency files change
  pull_request: {}     # Optional: Add PR scanning

jobs:
  snyk-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for pushing changes
      security-events: write  # For SARIF upload

    steps:
      # --- 🔧 1. Snyk Integration ---
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed for proper git diff

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Snyk CLI
        run: npm install -g snyk@latest

      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk test
        id: snyk-test
        run: |
          mkdir -p reports
          snyk test --file=pom.xml \
            --json-file-output=reports/snyk-results.json \
            --sarif-file-output=reports/snyk-results.sarif || true
          echo "Vulnerability count: $(jq '.vulnerabilities | length' reports/snyk-results.json)"

      # --- 📂 2. Saving the Report ---
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: changes
        run: |
          git add reports/
          if ! git diff --cached --quiet; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi

      # --- 🚀 3. Secure Push Solution ---
      - name: Commit and push changes
        if: steps.changes.outputs.changes_detected == 'true'
        run: |
          git commit -m "chore: update Snyk vulnerability report [skip ci]"
          git push
        env:
          # Using PAT as fallback if GITHUB_TOKEN fails
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || secrets.PERSONAL_TOKEN }}

      # --- 🔍 4. Optional Security Alerts ---
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/snyk-results.sarif
